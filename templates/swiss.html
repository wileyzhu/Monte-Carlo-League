<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiss Stage Simulation - Worlds 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .team-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .qualified {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
        }

        .eliminated {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff8f8 0%, #f5e8e8 100%);
        }

        .record-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .seed-group {
            padding: 10px;
            margin: 5px;
            border-radius: 8px;
            text-align: center;
        }

        .seed-top {
            background-color: #ffd700;
            color: #000;
        }

        .seed-mid {
            background-color: #c0c0c0;
            color: #000;
        }

        .seed-low {
            background-color: #cd7f32;
            color: #fff;
        }

        .round-result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }

        .matchup {
            padding: 12px;
            margin: 4px 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .matchup .score-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #007bff;
        }

        .winner {
            font-weight: bold;
            color: #28a745;
        }

        .loser {
            color: #6c757d;
        }

        .region-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }

        .region-LCK {
            background-color: #ff6b6b;
        }

        .region-LPL {
            background-color: #4ecdc4;
        }

        .region-LEC {
            background-color: #45b7d1;
        }

        .region-LTA {
            background-color: #96ceb4;
        }

        .region-PCS {
            background-color: #ffeaa7;
            color: #000;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-trophy"></i> Worlds 2025 Simulator
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Main Tournament</a>
                <a class="nav-link" href="/playin">Play-in</a>
                <a class="nav-link active" href="/swiss">Swiss Stage</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-chess-board"></i> Swiss Stage Simulation
                </h1>
                <p class="text-center text-muted">
                    Simulate the Swiss stage with 16 teams competing for 8 qualification spots
                </p>
            </div>
        </div>

        <!-- Team Pool Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-users"></i> Team Pool Configuration</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Play-in Winner:</label>
                                <select class="form-select" id="playin-winner">
                                    <option value="T1">T1 (LCK)</option>
                                    <option value="Invictus Gaming">Invictus Gaming (LPL)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Seeding Strategy:</label>
                                <select class="form-select" id="seeding-strategy">
                                    <option value="power">Power Rankings</option>
                                    <option value="regional">Regional Balance</option>
                                    <option value="random">Random</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Team Pool -->
        <div class="row mb-4" id="team-pool-section">
            <div class="col-12">
                <h3><i class="fas fa-list"></i> Current Team Pool</h3>
                <div id="team-pool-loading" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading team pool...
                </div>
                <div id="team-pool-content" style="display: none;">
                    <!-- Team pool will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Simulation Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-play"></i> Run Swiss Stage Simulation</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-primary btn-lg w-100 mb-2" onclick="runSingleSwiss()">
                                    <i class="fas fa-dice"></i> Single Swiss Simulation
                                </button>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group mb-2">
                                    <input type="number" class="form-control" id="num-simulations" value="100" min="1"
                                        max="1000" placeholder="Number of simulations">
                                    <button class="btn btn-success" onclick="runMultipleSwiss()">
                                        <i class="fas fa-chart-bar"></i> Multiple Simulations
                                    </button>
                                </div>
                                <small class="text-muted">Run 1-1000 Swiss simulations</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning btn-lg w-100 mb-2" onclick="showFirstDrawInput()">
                                    <i class="fas fa-edit"></i> Input First Draw Matchups
                                </button>
                                <small class="text-muted">Enter actual Round 1 matchups</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- First Draw Input -->
        <div class="row mb-4" id="first-draw-section" style="display: none;">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h4><i class="fas fa-edit"></i> Input First Draw Matchups</h4>
                        <small>Enter the actual matchup pairings from Round 1 of Swiss stage</small>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Play-in Winner</label>
                                <select class="form-select" id="draw-playin-winner">
                                    <option value="T1">T1</option>
                                    <option value="Invictus Gaming">Invictus Gaming</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Simulation Type</label>
                                <select class="form-select" id="simulation-type">
                                    <option value="qualification">Qualification Rates</option>
                                    <option value="matchup_results">Round 1 Match Results</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Number of Simulations</label>
                                <input type="number" class="form-control" id="draw-simulations" value="100" min="1" max="1000">
                            </div>
                        </div>
                        
                        <h6>Round 1 Matchups (8 matches)</h6>
                        <div class="row" id="first-draw-matches">
                            <div class="col-md-6 mb-2">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6>Match 1 <small class="text-muted">(Pool 1 vs Pool 3)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="1" data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="1" data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6>Match 2 <small class="text-muted">(Pool 1 vs Pool 3)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="2" data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="2" data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6>Match 3 <small class="text-muted">(Pool 1 vs Pool 3)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="3" data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="3" data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6>Match 4 <small class="text-muted">(Pool 1 vs Pool 3)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="4" data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="4" data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6>Match 5 <small class="text-muted">(Pool 1 vs Pool 3)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="5" data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="5" data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6>Match 6 <small class="text-muted">(Pool 2 vs Pool 2)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="6" data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="6" data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6>Match 7 <small class="text-muted">(Pool 2 vs Pool 2)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="7" data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="7" data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6>Match 8 <small class="text-muted">(Pool 2 vs Pool 2)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="8" data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="8" data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle"></i> <strong>Swiss Seeding Rules:</strong></small><br>
                            <small>
                                • <span class="text-primary">Matches 1-5:</span> Pool 1 (top 5 teams) vs Pool 3 (bottom 5 teams)<br>
                                • <span class="text-success">Matches 6-8:</span> Pool 2 (middle 6 teams) vs Pool 2<br>
                                • <span class="text-primary"><i class="fas fa-trophy"></i> Official Draw:</span> Loads the actual Worlds 2025 first draw matchups<br>
                                • Select matchups manually or use saved inputs. Simulation uses real win probabilities.
                            </small>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-2">
                                <button class="btn btn-secondary" onclick="hideFirstDrawInput()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary" onclick="loadOfficialDraw()">
                                    <i class="fas fa-trophy"></i> Official Draw
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-info" onclick="loadLastInput()" id="loadLastBtn" disabled>
                                    <i class="fas fa-history"></i> Last Input
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success" onclick="saveCurrentInput()">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning w-100" onclick="runSwissFromDraw()">
                                    <i class="fas fa-play"></i> Simulate from Draw
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="simulation-loading">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Running Swiss stage simulation...</p>
        </div>

        <!-- Results Container -->
        <div id="results-container" style="display: none;">
            <!-- Results will be displayed here -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load team pool on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadTeamPool();

            // Update team pool when play-in winner changes
            document.getElementById('playin-winner').addEventListener('change', loadTeamPool);
        });

        async function loadTeamPool() {
            try {
                const playinWinner = document.getElementById('playin-winner').value;
                console.log('Loading team pool with play-in winner:', playinWinner);

                document.getElementById('team-pool-loading').style.display = 'block';
                document.getElementById('team-pool-content').style.display = 'none';

                const response = await fetch(`/api/swiss/teams?playin_winner=${encodeURIComponent(playinWinner)}`);
                const data = await response.json();

                if (data.success) {
                    displayTeamPool(data);
                } else {
                    console.error('Error loading team pool:', data.error);
                }
            } catch (error) {
                console.error('Error loading team pool:', error);
            }
        }

        function displayTeamPool(data) {
            const container = document.getElementById('team-pool-content');
            const teams = data.teams;
            const seedGroups = data.seed_groups;

            // Group teams by seed pools: 5-6-5 distribution
            const seedGroupNames = ['Pool 0 (5)', 'Pool 1 (6)', 'Pool 2 (5)'];
            const seedClasses = ['seed-top', 'seed-mid', 'seed-low'];

            let html = '<div class="row">';

            for (let i = 0; i < 3; i++) {
                const teamsInGroup = teams.filter(team => seedGroups[team.name] === i);

                html += `
                    <div class="col-md-4">
                        <div class="seed-group ${seedClasses[i]}">
                            <h5>${seedGroupNames[i]}</h5>
                            ${teamsInGroup.map(team => `
                                <div class="mb-2">
                                    <strong>${team.name}</strong>
                                    <span class="region-badge region-${team.region}">${team.region}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            html += '</div>';

            container.innerHTML = html;
            document.getElementById('team-pool-loading').style.display = 'none';
            container.style.display = 'block';
        }

        async function runSingleSwiss() {
            console.log('Running single Swiss simulation...');
            showLoading();

            try {
                const playinWinner = document.getElementById('playin-winner').value;
                const seedingStrategy = document.getElementById('seeding-strategy').value;

                const response = await fetch('/api/swiss/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'single',
                        playin_winner: playinWinner,
                        seeding_strategy: seedingStrategy
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displaySingleSwissResult(data.result);
                } else {
                    showError(data.error);
                }
            } catch (error) {
                console.error('Swiss simulation error:', error);
                showError('Failed to run Swiss simulation: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function runMultipleSwiss() {
            const numSims = parseInt(document.getElementById('num-simulations').value);

            if (isNaN(numSims) || numSims < 1 || numSims > 1000) {
                alert('Please enter a number between 1 and 1000');
                return;
            }

            console.log(`Running ${numSims} Swiss simulations...`);
            document.getElementById('simulation-loading').innerHTML = `
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>Running ${numSims} Swiss stage simulations...</p>
            `;
            showLoading();

            try {
                const playinWinner = document.getElementById('playin-winner').value;
                const seedingStrategy = document.getElementById('seeding-strategy').value;

                const response = await fetch('/api/swiss/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'multiple',
                        num_simulations: numSims,
                        playin_winner: playinWinner,
                        seeding_strategy: seedingStrategy
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayMultipleSwissResults(data.result);
                } else {
                    showError(data.error);
                }
            } catch (error) {
                console.error('Multiple Swiss simulation error:', error);
                showError('Failed to run Swiss simulations: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displaySingleSwissResult(result) {
            const container = document.getElementById('results-container');

            // Display rounds exactly as returned by API (no re-grouping needed)
            let scheduleHtml = '';
            if (result.round_results) {
                const swissRounds = result.round_results.map((round, index) => ({
                    roundNumber: index + 1,
                    roundName: round.round_name,
                    matches: round.matches,
                    type: round.round_name.includes('Opening') ? 'opening' : 
                          round.round_name.includes('Mixed') ? 'mixed' : 'swiss'
                }));

                // Display grouped Swiss rounds
                swissRounds.forEach(round => {
                    const bo1Count = round.matches.filter(m => m.best_of === 1).length;
                    const bo3Count = round.matches.filter(m => m.best_of === 3).length;
                    
                    scheduleHtml += `
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-${round.type === 'opening' ? 'play' : round.type === 'mixed' ? 'exclamation-triangle' : 'chess-board'}"></i>
                                        Round ${round.roundNumber}: ${round.roundName}
                                    </h6>
                                    <div>
                                        ${bo1Count > 0 ? `<span class="badge bg-info me-1">${bo1Count} BO1</span>` : ''}
                                        ${bo3Count > 0 ? `<span class="badge bg-warning">${bo3Count} BO3</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    ${round.matches.map(match => `
                                        <div class="col-md-6 mb-2">
                                            <div class="matchup ${match.best_of === 3 ? 'border-warning' : ''}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="text-start">
                                                        <span class="${match.winner === match.team_a ? 'winner' : 'loser'}">${match.team_a}</span>
                                                        <small class="text-muted d-block">(${match.team_a_record_before})</small>
                                                    </div>
                                                    <div class="text-center">
                                                        <div class="badge ${match.best_of === 3 ? 'bg-warning text-dark' : 'bg-secondary'} mb-1">BO${match.best_of}</div>
                                                        <div class="fw-bold text-primary score-display">${match.score}</div>
                                                        <small class="text-muted">${match.games_played} game${match.games_played > 1 ? 's' : ''}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="${match.winner === match.team_b ? 'winner' : 'loser'}">${match.team_b}</span>
                                                        <small class="text-muted d-block">(${match.team_b_record_before})</small>
                                                    </div>
                                                </div>
                                                <div class="text-center mt-2">
                                                    <small class="text-success">
                                                        <i class="fas fa-trophy"></i> <strong>${match.winner}</strong>
                                                        ${match.best_of > 1 ? ` wins ${match.score}` : ' wins'}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = `
                <div class="row">
                    <!-- Results Summary -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-trophy"></i> Final Results</h4>
                            </div>
                            <div class="card-body">
                                <h5 class="text-success"><i class="fas fa-check"></i> Qualified (8)</h5>
                                ${result.qualified.map(team => `
                                    <div class="team-card qualified mb-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${team}</strong>
                                                <span class="region-badge region-${getTeamRegion(team)}">${getTeamRegion(team)}</span>
                                            </div>
                                            <div class="record-display">${result.records[team][0]}-${result.records[team][1]}</div>
                                        </div>
                                    </div>
                                `).join('')}
                                
                                <h5 class="text-danger mt-3"><i class="fas fa-times"></i> Eliminated (8)</h5>
                                ${result.eliminated.map(team => `
                                    <div class="team-card eliminated mb-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${team}</strong>
                                                <span class="region-badge region-${getTeamRegion(team)}">${getTeamRegion(team)}</span>
                                            </div>
                                            <div class="record-display">${result.records[team][0]}-${result.records[team][1]}</div>
                                        </div>
                                    </div>
                                `).join('')}
                                
                                <div class="mt-3">
                                    <h6>Regional Breakdown</h6>
                                    ${Object.entries(getRegionalBreakdown(result.qualified)).map(([region, count]) => `
                                        <div class="d-flex justify-content-between">
                                            <span>${region}:</span>
                                            <strong>${count} teams</strong>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Tournament Stats</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>Total Rounds:</span>
                                        <strong>${result.total_rounds}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>BO1 Matches:</span>
                                        <strong>${result.round_results ? result.round_results.reduce((sum, round) => sum + round.matches.filter(m => m.best_of === 1).length, 0) : 0}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>BO3 Matches:</span>
                                        <strong>${result.round_results ? result.round_results.reduce((sum, round) => sum + round.matches.filter(m => m.best_of === 3).length, 0) : 0}</strong>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Swiss Format</h6>
                                    <small class="text-muted">
                                        • BO1 for regular matches<br>
                                        • BO3 for elimination/advancement<br>
                                        • First to 3 wins qualifies<br>
                                        • First to 3 losses eliminated
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schedule and Scores -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-calendar-alt"></i> Swiss Stage Complete Results</h4>
                                <small class="text-muted">Total Rounds: ${result.total_rounds} | Format: BO1 + BO3 Elimination</small>
                            </div>
                            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                ${scheduleHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.style.display = 'block';
        }

        function displayMultipleSwissResults(result) {
            const container = document.getElementById('results-container');

            // Sort teams by qualification rate (qualification_stats is already an array)
            const sortedTeams = result.qualification_stats || [];

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-chart-bar"></i> Swiss Stage Analysis (${result.num_simulations} simulations)</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>Team Qualification Rates</h5>
                                <div class="row">
                                    ${sortedTeams.map(teamStat => `
                                        <div class="col-md-6 mb-2">
                                            <div class="team-card ${teamStat.percentage > 50 ? 'qualified' : 'eliminated'}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>${teamStat.team}</strong>
                                                        <span class="region-badge region-${getTeamRegion(teamStat.team)}">${getTeamRegion(teamStat.team)}</span>
                                                    </div>
                                                    <div class="record-display">${teamStat.percentage.toFixed(1)}%</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h5>Regional Analysis</h5>
                                ${(() => {
                                    const regionalStats = {};
                                    sortedTeams.forEach(teamStat => {
                                        const region = getTeamRegion(teamStat.team);
                                        if (!regionalStats[region]) {
                                            regionalStats[region] = { total: 0, avgRate: 0 };
                                        }
                                        regionalStats[region].total += 1;
                                        regionalStats[region].avgRate += teamStat.percentage;
                                    });
                                    
                                    return Object.entries(regionalStats).map(([region, stats]) => `
                                        <div class="stat-card mb-2">
                                            <h6>${region}</h6>
                                            <div class="h5">${(stats.avgRate / stats.total).toFixed(1)}%</div>
                                            <small class="text-muted">avg qualification rate</small>
                                        </div>
                                    `).join('');
                                })()}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.style.display = 'block';
        }

        function getTeamRegion(team) {
            const regions = {
                'Bilibili Gaming': 'LPL', 'Top Esports': 'LPL', 'Invictus Gaming': 'LPL', 'Anyone s Legend': 'LPL',
                'Gen.G eSports': 'LCK', 'Hanwha Life eSports': 'LCK', 'KT Rolster': 'LCK', 'T1': 'LCK',
                'G2 Esports': 'LEC', 'Fnatic': 'LEC', 'Movistar KOI': 'LEC',
                'FlyQuest': 'LTA', '100 Thieves': 'LTA', 'Vivo Keyd Stars': 'LTA',
                'PSG Talon': 'PCS', 'CTBC Flying Oyster': 'PCS', 'Team Secret Whales': 'PCS'
            };
            return regions[team] || 'Unknown';
        }

        function getRegionalBreakdown(teams) {
            const breakdown = {};
            teams.forEach(team => {
                const region = getTeamRegion(team);
                breakdown[region] = (breakdown[region] || 0) + 1;
            });
            return breakdown;
        }



        function showLoading() {
            document.getElementById('simulation-loading').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('simulation-loading').style.display = 'none';
        }

        function showError(message) {
            const container = document.getElementById('results-container');
            container.innerHTML = `<div class="alert alert-danger">Error: ${message}</div>`;
            container.style.display = 'block';
        }

        function showFirstDrawInput() {
            document.getElementById('first-draw-section').style.display = 'block';
            populateTeamSelects();
        }

        function hideFirstDrawInput() {
            document.getElementById('first-draw-section').style.display = 'none';
        }

        function populateTeamSelects() {
            const playinWinner = document.getElementById('draw-playin-winner').value;
            
            // Get team list based on playin winner (5-6-5 seeding)
            const teams = playinWinner === 'Invictus Gaming' ? 
                ['Bilibili Gaming', 'Gen.G eSports', 'G2 Esports', 'FlyQuest', 'CTBC Flying Oyster', 
                 'Anyone s Legend', 'Hanwha Life eSports', 'Movistar KOI', 'Vivo Keyd Stars', 
                 'Team Secret Whales', 'Top Esports', 'Invictus Gaming', 'KT Rolster', 'Fnatic', 
                 '100 Thieves', 'PSG Talon'] :
                ['Bilibili Gaming', 'Gen.G eSports', 'G2 Esports', 'FlyQuest', 'CTBC Flying Oyster', 
                 'Anyone s Legend', 'Hanwha Life eSports', 'Movistar KOI', 'Vivo Keyd Stars', 
                 'Team Secret Whales', 'KT Rolster', 'T1', 'Top Esports', 'Fnatic', 
                 '100 Thieves', 'PSG Talon'];

            // Divide teams into pools (5-6-5 distribution)
            const pool1 = teams.slice(0, 5);   // Top 5 teams
            const pool2 = teams.slice(5, 11);  // Middle 6 teams  
            const pool3 = teams.slice(11, 16); // Bottom 5 teams
            
            // Populate selects based on Swiss seeding rules
            // Matches 1-5: Pool 1 vs Pool 3
            for (let i = 1; i <= 5; i++) {
                const teamASelect = document.querySelector(`[data-match="${i}"][data-position="a"]`);
                const teamBSelect = document.querySelector(`[data-match="${i}"][data-position="b"]`);
                
                // Team A options: Pool 1 teams
                teamASelect.innerHTML = '<option value="">Select Pool 1 Team</option>';
                pool1.forEach(team => {
                    teamASelect.innerHTML += `<option value="${team}">${team} (Pool 1)</option>`;
                });
                
                // Team B options: Pool 3 teams
                teamBSelect.innerHTML = '<option value="">Select Pool 3 Team</option>';
                pool3.forEach(team => {
                    teamBSelect.innerHTML += `<option value="${team}">${team} (Pool 3)</option>`;
                });
            }
            
            // Matches 6-8: Pool 2 vs Pool 2
            for (let i = 6; i <= 8; i++) {
                const teamASelect = document.querySelector(`[data-match="${i}"][data-position="a"]`);
                const teamBSelect = document.querySelector(`[data-match="${i}"][data-position="b"]`);
                
                // Both teams from Pool 2
                teamASelect.innerHTML = '<option value="">Select Pool 2 Team A</option>';
                teamBSelect.innerHTML = '<option value="">Select Pool 2 Team B</option>';
                pool2.forEach(team => {
                    teamASelect.innerHTML += `<option value="${team}">${team} (Pool 2)</option>`;
                    teamBSelect.innerHTML += `<option value="${team}">${team} (Pool 2)</option>`;
                });
            }
        }

        async function runSwissFromDraw() {
            const playinWinner = document.getElementById('draw-playin-winner').value;
            const numSimulations = parseInt(document.getElementById('draw-simulations').value);
            const simulationType = document.getElementById('simulation-type').value;
            
            // Collect matchups
            const matchups = [];
            for (let i = 1; i <= 8; i++) {
                const teamA = document.querySelector(`[data-match="${i}"][data-position="a"]`).value;
                const teamB = document.querySelector(`[data-match="${i}"][data-position="b"]`).value;
                
                if (teamA && teamB && teamA !== teamB) {
                    matchups.push({
                        team_a: teamA,
                        team_b: teamB
                    });
                }
            }
            
            if (matchups.length !== 8) {
                alert('Please select all 8 matchups with different teams');
                return;
            }
            
            // Check for duplicate teams
            const allTeams = [];
            matchups.forEach(match => {
                allTeams.push(match.team_a, match.team_b);
            });
            const uniqueTeams = new Set(allTeams);
            if (uniqueTeams.size !== 16) {
                alert('Each team should appear exactly once in the matchups');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch('/api/swiss/simulate_from_draw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        first_draw_matchups: matchups,
                        playin_winner: playinWinner,
                        num_simulations: numSimulations,
                        simulation_type: simulationType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.simulation_type === 'matchup_results') {
                        displayMatchupResults(data.result);
                    } else {
                        displayFirstDrawResults(data.result);
                    }
                    hideFirstDrawInput();
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Failed to run simulation: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displayFirstDrawResults(result) {
            const container = document.getElementById('results-container');
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h4><i class="fas fa-edit"></i> Swiss Simulation from First Draw (${result.num_simulations} simulations)</h4>
                        <small>Based on actual Round 1 matchups with simulated outcomes</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>Team Qualification Rates</h5>
                                <div class="row">
                                    ${result.qualification_stats.map(teamStat => `
                                        <div class="col-md-6 mb-2">
                                            <div class="team-card ${teamStat.percentage > 50 ? 'qualified' : 'eliminated'}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>${teamStat.team}</strong>
                                                        <span class="region-badge region-${getTeamRegion(teamStat.team)}">${getTeamRegion(teamStat.team)}</span>
                                                    </div>
                                                    <div class="record-display">${teamStat.percentage.toFixed(1)}%</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h5>First Draw Matchups Used</h5>
                                ${result.first_draw_matchups.map((match, index) => `
                                    <div class="mb-2">
                                        <small><strong>Match ${index + 1}:</strong></small><br>
                                        <small>${match.team_a} vs ${match.team_b}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.style.display = 'block';
        }

        function saveCurrentInput() {
            const playinWinner = document.getElementById('draw-playin-winner').value;
            const numSimulations = document.getElementById('draw-simulations').value;
            
            // Collect current matchups
            const matchups = [];
            for (let i = 1; i <= 8; i++) {
                const teamA = document.querySelector(`[data-match="${i}"][data-position="a"]`).value;
                const teamB = document.querySelector(`[data-match="${i}"][data-position="b"]`).value;
                
                matchups.push({
                    match: i,
                    team_a: teamA,
                    team_b: teamB
                });
            }
            
            const savedInput = {
                playin_winner: playinWinner,
                num_simulations: numSimulations,
                matchups: matchups,
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('swiss_last_input', JSON.stringify(savedInput));
            
            // Enable load button
            document.getElementById('loadLastBtn').disabled = false;
            
            alert('Input saved successfully!');
        }

        function loadLastInput() {
            const savedData = localStorage.getItem('swiss_last_input');
            
            if (!savedData) {
                alert('No saved input found');
                return;
            }
            
            try {
                const savedInput = JSON.parse(savedData);
                
                // Set playin winner
                document.getElementById('draw-playin-winner').value = savedInput.playin_winner;
                document.getElementById('draw-simulations').value = savedInput.num_simulations;
                
                // Populate team selects first
                populateTeamSelects();
                
                // Wait a bit for selects to populate, then set values
                setTimeout(() => {
                    savedInput.matchups.forEach(matchup => {
                        const teamASelect = document.querySelector(`[data-match="${matchup.match}"][data-position="a"]`);
                        const teamBSelect = document.querySelector(`[data-match="${matchup.match}"][data-position="b"]`);
                        
                        if (teamASelect && teamBSelect) {
                            teamASelect.value = matchup.team_a;
                            teamBSelect.value = matchup.team_b;
                        }
                    });
                    
                    const saveDate = new Date(savedInput.timestamp).toLocaleString();
                    alert(`Last input loaded successfully!\nSaved on: ${saveDate}`);
                }, 100);
                
            } catch (error) {
                alert('Error loading saved input: ' + error.message);
            }
        }

        function loadOfficialDraw() {
            // Official first draw matchups
            const officialMatchups = [
                { match: 1, team_a: 'Bilibili Gaming', team_b: '100 Thieves' },
                { match: 2, team_a: 'Gen.G eSports', team_b: 'PSG Talon' },
                { match: 3, team_a: 'FlyQuest', team_b: 'T1' },
                { match: 4, team_a: 'CTBC Flying Oyster', team_b: 'Fnatic' },
                { match: 5, team_a: 'G2 Esports', team_b: 'Top Esports' },
                { match: 6, team_a: 'Anyone s Legend', team_b: 'Hanwha Life eSports' },
                { match: 7, team_a: 'Vivo Keyd Stars', team_b: 'Team Secret Whales' },
                { match: 8, team_a: 'Movistar KOI', team_b: 'KT Rolster' }
            ];
            
            // Set T1 as playin winner (since T1 is in the official draw)
            document.getElementById('draw-playin-winner').value = 'T1';
            
            // Populate team selects first
            populateTeamSelects();
            
            // Wait a bit for selects to populate, then set official values
            setTimeout(() => {
                officialMatchups.forEach(matchup => {
                    const teamASelect = document.querySelector(`[data-match="${matchup.match}"][data-position="a"]`);
                    const teamBSelect = document.querySelector(`[data-match="${matchup.match}"][data-position="b"]`);
                    
                    if (teamASelect && teamBSelect) {
                        teamASelect.value = matchup.team_a;
                        teamBSelect.value = matchup.team_b;
                    }
                });
                
                alert('Official Worlds 2025 first draw loaded successfully!');
            }, 100);
        }

        function checkForSavedInput() {
            const savedData = localStorage.getItem('swiss_last_input');
            if (savedData) {
                document.getElementById('loadLastBtn').disabled = false;
            }
        }

        function displayMatchupResults(result) {
            const container = document.getElementById('results-container');
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h4><i class="fas fa-dice"></i> Round 1 Matchup Results (${result.num_simulations} simulations)</h4>
                        <small>Probability of each team winning their Round 1 match</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            ${Object.entries(result.matchup_results).map(([matchId, matchResult]) => `
                                <div class="col-md-6 mb-3">
                                    <div class="card border-${matchResult.confidence > 70 ? 'success' : matchResult.confidence > 60 ? 'warning' : 'danger'}">
                                        <div class="card-header">
                                            <h6 class="mb-0">${matchId}: ${matchResult.matchup}</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6 text-center">
                                                    <div class="team-result">
                                                        <strong class="${matchResult.team_a_win_rate > matchResult.team_b_win_rate ? 'text-success' : 'text-muted'}">${matchResult.team_a}</strong>
                                                        <div class="h4 ${matchResult.team_a_win_rate > matchResult.team_b_win_rate ? 'text-success' : 'text-muted'}">
                                                            ${matchResult.team_a_win_rate.toFixed(1)}%
                                                        </div>
                                                        <small>${matchResult.team_a_wins}/${result.num_simulations} wins</small>
                                                    </div>
                                                </div>
                                                <div class="col-6 text-center">
                                                    <div class="team-result">
                                                        <strong class="${matchResult.team_b_win_rate > matchResult.team_a_win_rate ? 'text-success' : 'text-muted'}">${matchResult.team_b}</strong>
                                                        <div class="h4 ${matchResult.team_b_win_rate > matchResult.team_a_win_rate ? 'text-success' : 'text-muted'}">
                                                            ${matchResult.team_b_win_rate.toFixed(1)}%
                                                        </div>
                                                        <small>${matchResult.team_b_wins}/${result.num_simulations} wins</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-center mt-2">
                                                <small>
                                                    <i class="fas fa-trophy"></i> Favorite: 
                                                    <strong class="text-primary">${matchResult.most_likely_winner}</strong>
                                                    (${matchResult.confidence.toFixed(1)}%)
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="alert alert-success mt-3">
                            <h6><i class="fas fa-chart-bar"></i> Round 1 Analysis</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Most Confident Predictions:</strong>
                                    <ul class="mb-0">
                                        ${Object.entries(result.matchup_results)
                                            .sort(([,a], [,b]) => b.confidence - a.confidence)
                                            .slice(0, 3)
                                            .map(([matchId, matchResult]) => `
                                                <li>${matchResult.most_likely_winner} (${matchResult.confidence.toFixed(1)}%)</li>
                                            `).join('')}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <strong>Closest Matches:</strong>
                                    <ul class="mb-0">
                                        ${Object.entries(result.matchup_results)
                                            .sort(([,a], [,b]) => a.confidence - b.confidence)
                                            .slice(0, 3)
                                            .map(([matchId, matchResult]) => `
                                                <li>${matchResult.matchup} (${matchResult.confidence.toFixed(1)}%)</li>
                                            `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.style.display = 'block';
        }

        // Update team selects when playin winner changes
        document.addEventListener('DOMContentLoaded', function() {
            const playinSelect = document.getElementById('draw-playin-winner');
            if (playinSelect) {
                playinSelect.addEventListener('change', populateTeamSelects);
            }
            
            // Check for saved input on page load
            checkForSavedInput();
        });
    </script>
</body>

</html>