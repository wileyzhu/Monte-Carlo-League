<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiss Stage Simulation - Worlds 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .team-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .qualified {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
        }

        .eliminated {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff8f8 0%, #f5e8e8 100%);
        }

        .record-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .seed-group {
            padding: 10px;
            margin: 5px;
            border-radius: 8px;
            text-align: center;
        }

        .seed-top {
            background-color: #ffd700;
            color: #000;
        }

        .seed-mid {
            background-color: #c0c0c0;
            color: #000;
        }

        .seed-low {
            background-color: #cd7f32;
            color: #fff;
        }

        .round-result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }

        .matchup {
            padding: 12px;
            margin: 4px 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .matchup .score-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #007bff;
        }

        .winner {
            font-weight: bold;
            color: #28a745;
        }

        .loser {
            color: #6c757d;
        }

        .region-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }

        .region-LCK {
            background-color: #ff6b6b;
        }

        .region-LPL {
            background-color: #4ecdc4;
        }

        .region-LEC {
            background-color: #45b7d1;
        }

        .region-LTA {
            background-color: #96ceb4;
        }

        .region-PCS {
            background-color: #ffeaa7;
            color: #000;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-trophy"></i> Worlds 2025 Simulator
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Main Tournament</a>
                <a class="nav-link" href="/playin">Play-in</a>
                <a class="nav-link active" href="/swiss">Swiss Stage</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-chess-board"></i> Swiss Stage Simulation
                </h1>
                <p class="text-center text-muted">
                    Simulate the Swiss stage with 16 teams competing for 8 qualification spots
                </p>
            </div>
        </div>

        <!-- Team Pool Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-users"></i> Team Pool Configuration</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Play-in Winner:</label>
                                <select class="form-select" id="playin-winner">
                                    <option value="T1">T1 (LCK)</option>
                                    <option value="Invictus Gaming">Invictus Gaming (LPL)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Team Pool -->
        <div class="row mb-4" id="team-pool-section">
            <div class="col-12">
                <h3><i class="fas fa-list"></i> Current Team Pool</h3>
                <div id="team-pool-loading" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading team pool...
                </div>
                <div id="team-pool-content" style="display: none;">
                    <!-- Team pool will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Simulation Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-play"></i> Run Swiss Stage Simulation</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <button class="btn btn-primary btn-lg w-100 mb-2" onclick="runSingleSwiss()">
                                    <i class="fas fa-dice"></i> Single Swiss Simulation
                                </button>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group mb-2">
                                    <input type="number" class="form-control" id="num-simulations" value="100" min="1"
                                        max="1000" step="1" placeholder="Number of simulations"
                                        oninput="validateSimulationCount(this)">
                                    <button class="btn btn-success" onclick="runMultipleSwiss()">
                                        <i class="fas fa-chart-bar"></i> Multiple Simulations
                                    </button>
                                </div>
                                <small class="text-muted">Run 1-1000 Swiss simulations</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning btn-lg w-100 mb-2" onclick="showFirstDrawInput()">
                                    <i class="fas fa-edit"></i> Input First Draw Matchups
                                </button>
                                <small class="text-muted">Enter actual Round 1 matchups</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- First Draw Input -->
        <div class="row mb-4" id="first-draw-section" style="display: none;">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h4><i class="fas fa-edit"></i> Input First Draw Matchups</h4>
                        <small>Enter the actual matchup pairings from Round 1 of Swiss stage</small>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Play-in Winner</label>
                                <select class="form-select" id="draw-playin-winner">
                                    <option value="T1">T1</option>
                                    <option value="Invictus Gaming">Invictus Gaming</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Simulation Type</label>
                                <select class="form-select" id="simulation-type">
                                    <option value="qualification">Qualification Rates</option>
                                    <option value="matchup_results">Round 1 Match Results</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Number of Simulations</label>
                                <input type="number" class="form-control" id="draw-simulations" value="100" min="1"
                                    max="1000" step="1" oninput="validateSimulationCount(this)">
                            </div>
                        </div>

                        <h6>Round 1 Matchups (8 matches)</h6>
                        <div class="row" id="first-draw-matches">
                            <div class="col-md-6 mb-2">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6>Match 1 <small class="text-muted">(Pool 1 vs Pool 3)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="1"
                                                    data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="1"
                                                    data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6>Match 2 <small class="text-muted">(Pool 1 vs Pool 3)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="2"
                                                    data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="2"
                                                    data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6>Match 3 <small class="text-muted">(Pool 1 vs Pool 3)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="3"
                                                    data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="3"
                                                    data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6>Match 4 <small class="text-muted">(Pool 1 vs Pool 3)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="4"
                                                    data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="4"
                                                    data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6>Match 5 <small class="text-muted">(Pool 1 vs Pool 3)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="5"
                                                    data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="5"
                                                    data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6>Match 6 <small class="text-muted">(Pool 2 vs Pool 2)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="6"
                                                    data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="6"
                                                    data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6>Match 7 <small class="text-muted">(Pool 2 vs Pool 2)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="7"
                                                    data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="7"
                                                    data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6>Match 8 <small class="text-muted">(Pool 2 vs Pool 2)</small></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="8"
                                                    data-position="a">
                                                    <option value="">Team A</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <select class="form-select team-select" data-match="8"
                                                    data-position="b">
                                                    <option value="">Team B</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle"></i> <strong>Swiss Seeding Rules:</strong></small><br>
                            <small>
                                • <span class="text-primary">Matches 1-5:</span> Pool 1 (top 5 teams) vs Pool 3 (bottom
                                5 teams)<br>
                                • <span class="text-success">Matches 6-8:</span> Pool 2 (middle 6 teams) vs Pool 2<br>
                                • <span class="text-primary"><i class="fas fa-trophy"></i> Official Draw:</span> Loads
                                the actual Worlds 2025 first draw matchups<br>
                                • Select matchups manually or use saved inputs. Simulation uses real win probabilities.
                            </small>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-2">
                                <button class="btn btn-secondary" onclick="hideFirstDrawInput()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary" onclick="loadOfficialDraw()">
                                    <i class="fas fa-trophy"></i> Official Draw
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-info" onclick="loadLastInput()" id="loadLastBtn" disabled>
                                    <i class="fas fa-history"></i> Last Input
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success" onclick="saveCurrentInput()">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-warning w-100" onclick="runSwissFromDraw()">
                                    <i class="fas fa-play"></i> Simulate from Draw
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Round 3 Predictions Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h4><i class="fas fa-crystal-ball"></i> Round 3 Matchups - Predict Outcomes</h4>
                        <small>Current state after Round 2 - Simulate Round 3 and beyond for championship/qualification
                            predictions</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h5 class="text-warning"><i class="fas fa-crown"></i> High (2-0) Matches</h5>
                                <div class="list-group">
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div><strong>KT Rolster</strong> <span
                                                class="region-badge region-LCK">LCK</span></div>
                                        <div class="text-muted">vs</div>
                                        <div><strong>Top Esports</strong> <span
                                                class="region-badge region-LPL">LPL</span></div>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div><strong>CTBC Flying Oyster</strong> <span
                                                class="region-badge region-LCP">LCP</span></div>
                                        <div class="text-muted">vs</div>
                                        <div><strong>Anyone s Legend</strong> <span
                                                class="region-badge region-LPL">LPL</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h5 class="text-info"><i class="fas fa-balance-scale"></i> Middle (1-1) Matches</h5>
                                <div class="list-group">
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div><strong>Team Secret Whales</strong> <span
                                                class="region-badge region-LCP">LCP</span></div>
                                        <div class="text-muted">vs</div>
                                        <div><strong>FlyQuest</strong> <span class="region-badge region-LTA">LTA</span>
                                        </div>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div><strong>Gen.G eSports</strong> <span
                                                class="region-badge region-LCK">LCK</span></div>
                                        <div class="text-muted">vs</div>
                                        <div><strong>T1</strong> <span class="region-badge region-LCK">LCK</span></div>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div><strong>G2 Esports</strong> <span
                                                class="region-badge region-LEC">LEC</span></div>
                                        <div class="text-muted">vs</div>
                                        <div><strong>Bilibili Gaming</strong> <span
                                                class="region-badge region-LPL">LPL</span></div>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div><strong>100 Thieves</strong> <span
                                                class="region-badge region-LTA">LTA</span></div>
                                        <div class="text-muted">vs</div>
                                        <div><strong>Hanwha Life eSports</strong> <span
                                                class="region-badge region-LCK">LCK</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h5 class="text-danger"><i class="fas fa-exclamation-triangle"></i> Low (0-2) Matches
                                </h5>
                                <div class="list-group">
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div><strong>Movistar KOI</strong> <span
                                                class="region-badge region-LEC">LEC</span></div>
                                        <div class="text-muted">vs</div>
                                        <div><strong>Fnatic</strong> <span class="region-badge region-LEC">LEC</span>
                                        </div>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div><strong>Vivo Keyd Stars</strong> <span
                                                class="region-badge region-LTA">LTA</span></div>
                                        <div class="text-muted">vs</div>
                                        <div><strong>PSG Talon</strong> <span class="region-badge region-LCP">LCP</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div><strong>Hanwha Life eSports</strong> <span class="region-badge region-LCK">LCK</span>
                            </div>
                            <div class="text-muted">vs</div>
                            <div><strong>PSG Talon</strong> <span class="region-badge region-LCP">LCP</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <button class="btn btn-primary w-100" onclick="showRound3Predictions()">
                        <i class="fas fa-crystal-ball"></i> Predict Round 3 Outcomes
                    </button>
                    <small class="text-muted">Simulate Round 3 match results</small>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-success w-100" onclick="showMatchPredictions()">
                        <i class="fas fa-chart-line"></i> Match Win Probabilities
                    </button>
                    <small class="text-muted">Head-to-head win chances</small>
                </div>
            </div>

            <!-- Simulation Controls Panel -->
            <div id="simulation-controls" class="mt-4">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-cogs"></i> Run Custom Simulations</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Number of Simulations:</label>
                                <input type="number" class="form-control" id="sim-count" value="500" min="1" max="10000"
                                    step="1" oninput="validateSimulationCount(this)">
                                <small class="text-muted">1 - 10,000 simulations</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Analysis Type:</label>
                                <select class="form-select" id="analysis-type" onchange="updateDisplayOptions()">
                                    <option value="qualification">Qualification Rates</option>
                                    <option value="championship">Championship Distribution</option>
                                    <option value="regional">Regional Performance</option>
                                    <option value="matchups">Round 3 Match Outcomes</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <button class="btn btn-primary w-100 mt-4" onclick="runCustomSimulation()">
                                    <i class="fas fa-play"></i> Run Simulation
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>



    <!-- Loading Indicator -->
    <div class="loading" id="simulation-loading">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p>Running Swiss stage simulation...</p>
    </div>

    <!-- Results Container -->
    <div id="results-container" style="display: none;">
        <!-- Results will be displayed here -->
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load team pool on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadTeamPool();

            // Update team pool when play-in winner changes
            document.getElementById('playin-winner').addEventListener('change', loadTeamPool);
        });

        async function loadTeamPool() {
            try {
                const playinWinner = document.getElementById('playin-winner').value;
                console.log('Loading team pool with play-in winner:', playinWinner);

                document.getElementById('team-pool-loading').style.display = 'block';
                document.getElementById('team-pool-content').style.display = 'none';

                const response = await fetch(`/api/swiss/teams?playin_winner=${encodeURIComponent(playinWinner)}`);
                const data = await response.json();

                if (data.success) {
                    displayTeamPool(data);
                } else {
                    console.error('Error loading team pool:', data.error);
                }
            } catch (error) {
                console.error('Error loading team pool:', error);
            }
        }

        function displayTeamPool(data) {
            const container = document.getElementById('team-pool-content');
            const teams = data.teams;
            const seedGroups = data.seed_groups;

            // Group teams by seed pools: 5-6-5 distribution
            const seedGroupNames = ['Pool 0 (5)', 'Pool 1 (6)', 'Pool 2 (5)'];
            const seedClasses = ['seed-top', 'seed-mid', 'seed-low'];

            let html = '<div class="row">';

            for (let i = 0; i < 3; i++) {
                const teamsInGroup = teams.filter(team => seedGroups[team.name] === i);

                html += `
                    <div class="col-md-4">
                        <div class="seed-group ${seedClasses[i]}">
                            <h5>${seedGroupNames[i]}</h5>
                            ${teamsInGroup.map(team => `
                                <div class="mb-2">
                                    <strong>${team.name}</strong>
                                    <span class="region-badge region-${team.region}">${team.region}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            html += '</div>';

            container.innerHTML = html;
            document.getElementById('team-pool-loading').style.display = 'none';
            container.style.display = 'block';
        }

        async function runSingleSwiss() {
            console.log('Running single Swiss simulation...');
            showLoading();

            try {
                const playinWinner = document.getElementById('playin-winner').value;
                const seedingStrategy = 'power'; // Default seeding strategy

                const response = await fetch('/api/swiss/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'single',
                        playin_winner: playinWinner,
                        seeding_strategy: seedingStrategy
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displaySingleSwissResult(data.result);
                } else {
                    showError(data.error);
                }
            } catch (error) {
                console.error('Swiss simulation error:', error);
                showError('Failed to run Swiss simulation: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function runMultipleSwiss() {
            const numSims = parseInt(document.getElementById('num-simulations').value);

            if (isNaN(numSims) || numSims < 1 || numSims > 1000) {
                alert('Please enter a number between 1 and 1000');
                return;
            }

            // Check if analysis type dropdown exists and get its value
            const analysisTypeElement = document.getElementById('analysis-type');
            const analysisType = analysisTypeElement ? analysisTypeElement.value : 'qualification';
            const displayFormat = 'table'; // Default to table format

            console.log(`Running ${numSims} Swiss simulations with analysis type: ${analysisType}...`);
            document.getElementById('simulation-loading').innerHTML = `
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>Running ${numSims} Swiss stage simulations (${analysisType})...</p>
            `;
            showLoading();

            try {
                const playinWinner = document.getElementById('playin-winner').value;
                const seedingStrategy = 'power'; // Default seeding strategy

                const response = await fetch('/api/swiss/simulate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'multiple',
                        num_simulations: numSims,
                        playin_winner: playinWinner,
                        seeding_strategy: seedingStrategy,
                        analysis_type: analysisType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Use the formatSimulationResults function to handle different analysis types
                    const container = document.getElementById('results-container');
                    const results = formatSimulationResults(data.result, analysisType, displayFormat, numSims);
                    container.innerHTML = results;
                    container.style.display = 'block';
                } else {
                    showError(data.error);
                }
            } catch (error) {
                console.error('Multiple Swiss simulation error:', error);
                showError('Failed to run Swiss simulations: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displaySingleSwissResult(result) {
            const container = document.getElementById('results-container');

            // Display rounds exactly as returned by API (no re-grouping needed)
            let scheduleHtml = '';
            if (result.round_results) {
                const swissRounds = result.round_results.map((round, index) => ({
                    roundNumber: index + 1,
                    roundName: round.round_name,
                    matches: round.matches,
                    type: round.round_name.includes('Opening') ? 'opening' :
                        round.round_name.includes('Mixed') ? 'mixed' : 'swiss'
                }));

                // Display grouped Swiss rounds
                swissRounds.forEach(round => {
                    const bo1Count = round.matches.filter(m => m.best_of === 1).length;
                    const bo3Count = round.matches.filter(m => m.best_of === 3).length;

                    scheduleHtml += `
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-${round.type === 'opening' ? 'play' : round.type === 'mixed' ? 'exclamation-triangle' : 'chess-board'}"></i>
                                        Round ${round.roundNumber}: ${round.roundName}
                                    </h6>
                                    <div>
                                        ${bo1Count > 0 ? `<span class="badge bg-info me-1">${bo1Count} BO1</span>` : ''}
                                        ${bo3Count > 0 ? `<span class="badge bg-warning">${bo3Count} BO3</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    ${round.matches.map(match => `
                                        <div class="col-md-6 mb-2">
                                            <div class="matchup ${match.best_of === 3 ? 'border-warning' : ''}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="text-start">
                                                        <span class="${match.winner === match.team_a ? 'winner' : 'loser'}">${match.team_a}</span>
                                                        <small class="text-muted d-block">(${match.team_a_record_before})</small>
                                                    </div>
                                                    <div class="text-center">
                                                        <div class="badge ${match.best_of === 3 ? 'bg-warning text-dark' : 'bg-secondary'} mb-1">BO${match.best_of}</div>
                                                        <div class="fw-bold text-primary score-display">${match.score}</div>
                                                        <small class="text-muted">${match.games_played} game${match.games_played > 1 ? 's' : ''}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="${match.winner === match.team_b ? 'winner' : 'loser'}">${match.team_b}</span>
                                                        <small class="text-muted d-block">(${match.team_b_record_before})</small>
                                                    </div>
                                                </div>
                                                <div class="text-center mt-2">
                                                    <small class="text-success">
                                                        <i class="fas fa-trophy"></i> <strong>${match.winner}</strong>
                                                        ${match.best_of > 1 ? ` wins ${match.score}` : ' wins'}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = `
                <div class="row">
                    <!-- Results Summary -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-trophy"></i> Final Results</h4>
                            </div>
                            <div class="card-body">
                                <h5 class="text-success"><i class="fas fa-check"></i> Qualified (8)</h5>
                                ${result.qualified.map(team => `
                                    <div class="team-card qualified mb-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${team}</strong>
                                                <span class="region-badge region-${getTeamRegion(team)}">${getTeamRegion(team)}</span>
                                            </div>
                                            <div class="record-display">${result.records[team][0]}-${result.records[team][1]}</div>
                                        </div>
                                    </div>
                                `).join('')}
                                
                                <h5 class="text-danger mt-3"><i class="fas fa-times"></i> Eliminated (8)</h5>
                                ${result.eliminated.map(team => `
                                    <div class="team-card eliminated mb-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${team}</strong>
                                                <span class="region-badge region-${getTeamRegion(team)}">${getTeamRegion(team)}</span>
                                            </div>
                                            <div class="record-display">${result.records[team][0]}-${result.records[team][1]}</div>
                                        </div>
                                    </div>
                                `).join('')}
                                
                                <div class="mt-3">
                                    <h6>Regional Breakdown</h6>
                                    ${Object.entries(getRegionalBreakdown(result.qualified)).map(([region, count]) => `
                                        <div class="d-flex justify-content-between">
                                            <span>${region}:</span>
                                            <strong>${count} teams</strong>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Tournament Stats</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>Total Rounds:</span>
                                        <strong>${result.total_rounds}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>BO1 Matches:</span>
                                        <strong>${result.round_results ? result.round_results.reduce((sum, round) => sum + round.matches.filter(m => m.best_of === 1).length, 0) : 0}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>BO3 Matches:</span>
                                        <strong>${result.round_results ? result.round_results.reduce((sum, round) => sum + round.matches.filter(m => m.best_of === 3).length, 0) : 0}</strong>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Swiss Format</h6>
                                    <small class="text-muted">
                                        • BO1 for regular matches<br>
                                        • BO3 for elimination/advancement<br>
                                        • First to 3 wins qualifies<br>
                                        • First to 3 losses eliminated
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schedule and Scores -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h4><i class="fas fa-calendar-alt"></i> Swiss Stage Complete Results</h4>
                                <small class="text-muted">Total Rounds: ${result.total_rounds} | Format: BO1 + BO3 Elimination</small>
                            </div>
                            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                ${scheduleHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.style.display = 'block';
        }

        function displayMultipleSwissResults(result) {
            const container = document.getElementById('results-container');

            // Sort teams by qualification rate (qualification_stats is already an array)
            const sortedTeams = result.qualification_stats || [];

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-chart-bar"></i> Swiss Stage Analysis (${result.num_simulations} simulations)</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>Team Qualification Rates</h5>
                                <div class="row">
                                    ${sortedTeams.map(teamStat => `
                                        <div class="col-md-6 mb-2">
                                            <div class="team-card ${teamStat.percentage > 50 ? 'qualified' : 'eliminated'}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>${teamStat.team}</strong>
                                                        <span class="region-badge region-${getTeamRegion(teamStat.team)}">${getTeamRegion(teamStat.team)}</span>
                                                    </div>
                                                    <div class="record-display">${teamStat.percentage.toFixed(1)}%</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h5>Regional Analysis</h5>
                                ${(() => {
                    const regionalStats = {};
                    sortedTeams.forEach(teamStat => {
                        const region = getTeamRegion(teamStat.team);
                        if (!regionalStats[region]) {
                            regionalStats[region] = { total: 0, avgRate: 0 };
                        }
                        regionalStats[region].total += 1;
                        regionalStats[region].avgRate += teamStat.percentage;
                    });

                    return Object.entries(regionalStats).map(([region, stats]) => `
                                        <div class="stat-card mb-2">
                                            <h6>${region}</h6>
                                            <div class="h5">${(stats.avgRate / stats.total).toFixed(1)}%</div>
                                            <small class="text-muted">avg qualification rate</small>
                                        </div>
                                    `).join('');
                })()}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.style.display = 'block';
        }

        function getTeamRegion(team) {
            const regions = {
                'Bilibili Gaming': 'LPL', 'Top Esports': 'LPL', 'Invictus Gaming': 'LPL', 'Anyone s Legend': 'LPL',
                'Gen.G eSports': 'LCK', 'Hanwha Life eSports': 'LCK', 'KT Rolster': 'LCK', 'T1': 'LCK',
                'G2 Esports': 'LEC', 'Fnatic': 'LEC', 'Movistar KOI': 'LEC',
                'FlyQuest': 'LTA', '100 Thieves': 'LTA', 'Vivo Keyd Stars': 'LTA',
                'PSG Talon': 'PCS', 'CTBC Flying Oyster': 'PCS', 'Team Secret Whales': 'PCS'
            };
            return regions[team] || 'Unknown';
        }

        function getRegionalBreakdown(teams) {
            const breakdown = {};
            teams.forEach(team => {
                const region = getTeamRegion(team);
                breakdown[region] = (breakdown[region] || 0) + 1;
            });
            return breakdown;
        }



        function showLoading() {
            document.getElementById('simulation-loading').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('simulation-loading').style.display = 'none';
        }

        function showError(message) {
            const container = document.getElementById('results-container');
            container.innerHTML = `<div class="alert alert-danger">Error: ${message}</div>`;
            container.style.display = 'block';
        }

        function showFirstDrawInput() {
            document.getElementById('first-draw-section').style.display = 'block';
            populateTeamSelects();
        }

        function hideFirstDrawInput() {
            document.getElementById('first-draw-section').style.display = 'none';
        }

        function populateTeamSelects() {
            const playinWinner = document.getElementById('draw-playin-winner').value;

            // Get team list based on playin winner (5-6-5 seeding)
            const teams = playinWinner === 'Invictus Gaming' ?
                ['Bilibili Gaming', 'Gen.G eSports', 'G2 Esports', 'FlyQuest', 'CTBC Flying Oyster',
                    'Anyone s Legend', 'Hanwha Life eSports', 'Movistar KOI', 'Vivo Keyd Stars',
                    'Team Secret Whales', 'Top Esports', 'Invictus Gaming', 'KT Rolster', 'Fnatic',
                    '100 Thieves', 'PSG Talon'] :
                ['Bilibili Gaming', 'Gen.G eSports', 'G2 Esports', 'FlyQuest', 'CTBC Flying Oyster',
                    'Anyone s Legend', 'Hanwha Life eSports', 'Movistar KOI', 'Vivo Keyd Stars',
                    'Team Secret Whales', 'KT Rolster', 'T1', 'Top Esports', 'Fnatic',
                    '100 Thieves', 'PSG Talon'];

            // Divide teams into pools (5-6-5 distribution)
            const pool1 = teams.slice(0, 5);   // Top 5 teams
            const pool2 = teams.slice(5, 11);  // Middle 6 teams  
            const pool3 = teams.slice(11, 16); // Bottom 5 teams

            // Populate selects based on Swiss seeding rules
            // Matches 1-5: Pool 1 vs Pool 3
            for (let i = 1; i <= 5; i++) {
                const teamASelect = document.querySelector(`[data-match="${i}"][data-position="a"]`);
                const teamBSelect = document.querySelector(`[data-match="${i}"][data-position="b"]`);

                // Team A options: Pool 1 teams
                teamASelect.innerHTML = '<option value="">Select Pool 1 Team</option>';
                pool1.forEach(team => {
                    teamASelect.innerHTML += `<option value="${team}">${team} (Pool 1)</option>`;
                });

                // Team B options: Pool 3 teams
                teamBSelect.innerHTML = '<option value="">Select Pool 3 Team</option>';
                pool3.forEach(team => {
                    teamBSelect.innerHTML += `<option value="${team}">${team} (Pool 3)</option>`;
                });
            }

            // Matches 6-8: Pool 2 vs Pool 2
            for (let i = 6; i <= 8; i++) {
                const teamASelect = document.querySelector(`[data-match="${i}"][data-position="a"]`);
                const teamBSelect = document.querySelector(`[data-match="${i}"][data-position="b"]`);

                // Both teams from Pool 2
                teamASelect.innerHTML = '<option value="">Select Pool 2 Team A</option>';
                teamBSelect.innerHTML = '<option value="">Select Pool 2 Team B</option>';
                pool2.forEach(team => {
                    teamASelect.innerHTML += `<option value="${team}">${team} (Pool 2)</option>`;
                    teamBSelect.innerHTML += `<option value="${team}">${team} (Pool 2)</option>`;
                });
            }
        }

        async function runSwissFromDraw() {
            const playinWinner = document.getElementById('draw-playin-winner').value;
            const numSimulations = parseInt(document.getElementById('draw-simulations').value);
            const simulationType = document.getElementById('simulation-type').value;

            // Collect matchups
            const matchups = [];
            for (let i = 1; i <= 8; i++) {
                const teamA = document.querySelector(`[data-match="${i}"][data-position="a"]`).value;
                const teamB = document.querySelector(`[data-match="${i}"][data-position="b"]`).value;

                if (teamA && teamB && teamA !== teamB) {
                    matchups.push({
                        team_a: teamA,
                        team_b: teamB
                    });
                }
            }

            if (matchups.length !== 8) {
                alert('Please select all 8 matchups with different teams');
                return;
            }

            // Check for duplicate teams
            const allTeams = [];
            matchups.forEach(match => {
                allTeams.push(match.team_a, match.team_b);
            });
            const uniqueTeams = new Set(allTeams);
            if (uniqueTeams.size !== 16) {
                alert('Each team should appear exactly once in the matchups');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/api/swiss/simulate_from_draw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        first_draw_matchups: matchups,
                        playin_winner: playinWinner,
                        num_simulations: numSimulations,
                        simulation_type: simulationType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.simulation_type === 'matchup_results') {
                        displayMatchupResults(data.result);
                    } else {
                        displayFirstDrawResults(data.result);
                    }
                    hideFirstDrawInput();
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Failed to run simulation: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displayFirstDrawResults(result) {
            const container = document.getElementById('results-container');

            container.innerHTML = `
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h4><i class="fas fa-edit"></i> Swiss Simulation from First Draw (${result.num_simulations} simulations)</h4>
                        <small>Based on actual Round 1 matchups with simulated outcomes</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>Team Qualification Rates</h5>
                                <div class="row">
                                    ${result.qualification_stats.map(teamStat => `
                                        <div class="col-md-6 mb-2">
                                            <div class="team-card ${teamStat.percentage > 50 ? 'qualified' : 'eliminated'}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>${teamStat.team}</strong>
                                                        <span class="region-badge region-${getTeamRegion(teamStat.team)}">${getTeamRegion(teamStat.team)}</span>
                                                    </div>
                                                    <div class="record-display">${teamStat.percentage.toFixed(1)}%</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h5>First Draw Matchups Used</h5>
                                ${result.first_draw_matchups.map((match, index) => `
                                    <div class="mb-2">
                                        <small><strong>Match ${index + 1}:</strong></small><br>
                                        <small>${match.team_a} vs ${match.team_b}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.style.display = 'block';
        }

        function saveCurrentInput() {
            const playinWinner = document.getElementById('draw-playin-winner').value;
            const numSimulations = document.getElementById('draw-simulations').value;

            // Collect current matchups
            const matchups = [];
            for (let i = 1; i <= 8; i++) {
                const teamA = document.querySelector(`[data-match="${i}"][data-position="a"]`).value;
                const teamB = document.querySelector(`[data-match="${i}"][data-position="b"]`).value;

                matchups.push({
                    match: i,
                    team_a: teamA,
                    team_b: teamB
                });
            }

            const savedInput = {
                playin_winner: playinWinner,
                num_simulations: numSimulations,
                matchups: matchups,
                timestamp: new Date().toISOString()
            };

            // Save to localStorage
            localStorage.setItem('swiss_last_input', JSON.stringify(savedInput));

            // Enable load button
            document.getElementById('loadLastBtn').disabled = false;

            alert('Input saved successfully!');
        }

        function loadLastInput() {
            const savedData = localStorage.getItem('swiss_last_input');

            if (!savedData) {
                alert('No saved input found');
                return;
            }

            try {
                const savedInput = JSON.parse(savedData);

                // Set playin winner
                document.getElementById('draw-playin-winner').value = savedInput.playin_winner;
                document.getElementById('draw-simulations').value = savedInput.num_simulations;

                // Populate team selects first
                populateTeamSelects();

                // Wait a bit for selects to populate, then set values
                setTimeout(() => {
                    savedInput.matchups.forEach(matchup => {
                        const teamASelect = document.querySelector(`[data-match="${matchup.match}"][data-position="a"]`);
                        const teamBSelect = document.querySelector(`[data-match="${matchup.match}"][data-position="b"]`);

                        if (teamASelect && teamBSelect) {
                            teamASelect.value = matchup.team_a;
                            teamBSelect.value = matchup.team_b;
                        }
                    });

                    const saveDate = new Date(savedInput.timestamp).toLocaleString();
                    alert(`Last input loaded successfully!\nSaved on: ${saveDate}`);
                }, 100);

            } catch (error) {
                alert('Error loading saved input: ' + error.message);
            }
        }

        function loadOfficialDraw() {
            // Official first draw matchups
            const officialMatchups = [
                { match: 1, team_a: 'Bilibili Gaming', team_b: '100 Thieves' },
                { match: 2, team_a: 'Gen.G eSports', team_b: 'PSG Talon' },
                { match: 3, team_a: 'FlyQuest', team_b: 'T1' },
                { match: 4, team_a: 'CTBC Flying Oyster', team_b: 'Fnatic' },
                { match: 5, team_a: 'G2 Esports', team_b: 'Top Esports' },
                { match: 6, team_a: 'Anyone s Legend', team_b: 'Hanwha Life eSports' },
                { match: 7, team_a: 'Vivo Keyd Stars', team_b: 'Team Secret Whales' },
                { match: 8, team_a: 'Movistar KOI', team_b: 'KT Rolster' }
            ];

            // Set T1 as playin winner (since T1 is in the official draw)
            document.getElementById('draw-playin-winner').value = 'T1';

            // Populate team selects first
            populateTeamSelects();

            // Wait a bit for selects to populate, then set official values
            setTimeout(() => {
                officialMatchups.forEach(matchup => {
                    const teamASelect = document.querySelector(`[data-match="${matchup.match}"][data-position="a"]`);
                    const teamBSelect = document.querySelector(`[data-match="${matchup.match}"][data-position="b"]`);

                    if (teamASelect && teamBSelect) {
                        teamASelect.value = matchup.team_a;
                        teamBSelect.value = matchup.team_b;
                    }
                });

                alert('Official Worlds 2025 first draw loaded successfully!');
            }, 100);
        }

        function checkForSavedInput() {
            const savedData = localStorage.getItem('swiss_last_input');
            if (savedData) {
                document.getElementById('loadLastBtn').disabled = false;
            }
        }

        function displayMatchupResults(result) {
            const container = document.getElementById('results-container');

            container.innerHTML = `
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h4><i class="fas fa-dice"></i> Round 1 Matchup Results (${result.num_simulations} simulations)</h4>
                        <small>Probability of each team winning their Round 1 match</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            ${Object.entries(result.matchup_results).map(([matchId, matchResult]) => `
                                <div class="col-md-6 mb-3">
                                    <div class="card border-${matchResult.confidence > 70 ? 'success' : matchResult.confidence > 60 ? 'warning' : 'danger'}">
                                        <div class="card-header">
                                            <h6 class="mb-0">${matchId}: ${matchResult.matchup}</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6 text-center">
                                                    <div class="team-result">
                                                        <strong class="${matchResult.team_a_win_rate > matchResult.team_b_win_rate ? 'text-success' : 'text-muted'}">${matchResult.team_a}</strong>
                                                        <div class="h4 ${matchResult.team_a_win_rate > matchResult.team_b_win_rate ? 'text-success' : 'text-muted'}">
                                                            ${matchResult.team_a_win_rate.toFixed(1)}%
                                                        </div>
                                                        <small>${matchResult.team_a_wins}/${result.num_simulations} wins</small>
                                                    </div>
                                                </div>
                                                <div class="col-6 text-center">
                                                    <div class="team-result">
                                                        <strong class="${matchResult.team_b_win_rate > matchResult.team_a_win_rate ? 'text-success' : 'text-muted'}">${matchResult.team_b}</strong>
                                                        <div class="h4 ${matchResult.team_b_win_rate > matchResult.team_a_win_rate ? 'text-success' : 'text-muted'}">
                                                            ${matchResult.team_b_win_rate.toFixed(1)}%
                                                        </div>
                                                        <small>${matchResult.team_b_wins}/${result.num_simulations} wins</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-center mt-2">
                                                <small>
                                                    <i class="fas fa-trophy"></i> Favorite: 
                                                    <strong class="text-primary">${matchResult.most_likely_winner}</strong>
                                                    (${matchResult.confidence.toFixed(1)}%)
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="alert alert-success mt-3">
                            <h6><i class="fas fa-chart-bar"></i> Round 1 Analysis</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Most Confident Predictions:</strong>
                                    <ul class="mb-0">
                                        ${Object.entries(result.matchup_results)
                    .sort(([, a], [, b]) => b.confidence - a.confidence)
                    .slice(0, 3)
                    .map(([matchId, matchResult]) => `
                                                <li>${matchResult.most_likely_winner} (${matchResult.confidence.toFixed(1)}%)</li>
                                            `).join('')}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <strong>Closest Matches:</strong>
                                    <ul class="mb-0">
                                        ${Object.entries(result.matchup_results)
                    .sort(([, a], [, b]) => a.confidence - b.confidence)
                    .slice(0, 3)
                    .map(([matchId, matchResult]) => `
                                                <li>${matchResult.matchup} (${matchResult.confidence.toFixed(1)}%)</li>
                                            `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.style.display = 'block';
        }

        // Update team selects when playin winner changes
        document.addEventListener('DOMContentLoaded', function () {
            const playinSelect = document.getElementById('draw-playin-winner');
            if (playinSelect) {
                playinSelect.addEventListener('change', populateTeamSelects);
            }

            // Check for saved input on page load
            checkForSavedInput();
        });

        async function showRound3Predictions() {
            const container = document.getElementById('results-container');
            container.innerHTML = '<div class="alert alert-primary"><i class="fas fa-spinner fa-spin"></i> Predicting Round 3 outcomes...</div>';
            container.style.display = 'block';

            try {
                // Simulate Round 3 match outcomes
                const response = await fetch('/api/swiss/simulate_round3_outcomes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        num_simulations: 1000,
                        playin_winner: 'T1'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayRound3Predictions(data.result);
                } else {
                    container.innerHTML = '<div class="alert alert-danger">Failed to predict Round 3 outcomes: ' + data.error + '</div>';
                }
            } catch (error) {
                console.error('Round 3 prediction error:', error);
                container.innerHTML = '<div class="alert alert-danger">Failed to predict Round 3 outcomes: ' + error.message + '</div>';
            }
        }

        async function showMatchPredictions() {
            const container = document.getElementById('results-container');
            container.innerHTML = '<div class="alert alert-primary"><i class="fas fa-spinner fa-spin"></i> Loading match predictions...</div>';
            container.style.display = 'block';

            try {
                const response = await fetch('/api/swiss/match_predictions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.success) {
                    displayMatchPredictions(data.result);
                } else {
                    container.innerHTML = '<div class="alert alert-danger">Error loading predictions: ' + data.error + '</div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="alert alert-danger">Network error: ' + error.message + '</div>';
            }
        }

        function formatRound3PredictionsHTML(result, simCount) {
            // This function returns HTML for Round 3 predictions (used by custom simulations)
            console.log('formatRound3PredictionsHTML called with:', result);

            const matches = result.matches || {};

            let html = `
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h4><i class="fas fa-crystal-ball"></i> Round 3 Match Outcome Simulations</h4>
                        <small>Results from ${result.num_simulations || simCount} simulations (BO3 for high/low matches, BO1 for middle)</small>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h5 class="text-warning"><i class="fas fa-crown"></i> High Stakes (2-0 vs 2-0) - BO3</h5>
                                <div class="row">
            `;

            // High matches
            const highMatches = ['kt_rolster_vs_top_esports', 'ctbc_flying_oyster_vs_anyone_s_legend'];
            highMatches.forEach(key => {
                const match = matches[key];
                if (match) {
                    const winner = match.team_a_wins > match.team_b_wins ? match.team_a : match.team_b;
                    const winPct = Math.max(match.team_a_pct, match.team_b_pct);
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <h6><strong>${match.team_a}</strong> vs <strong>${match.team_b}</strong></h6>
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar bg-primary" style="width: ${match.team_a_pct}%">${match.team_a_wins}</div>
                                        <div class="progress-bar bg-secondary" style="width: ${match.team_b_pct}%">${match.team_b_wins}</div>
                                    </div>
                                    <small><strong>${match.team_a}:</strong> ${match.team_a_wins} wins (${match.team_a_pct.toFixed(1)}%)</small><br>
                                    <small><strong>${match.team_b}:</strong> ${match.team_b_wins} wins (${match.team_b_pct.toFixed(1)}%)</small><br>
                                    <small class="text-success"><strong>Predicted Winner: ${winner}</strong> (${winPct.toFixed(1)}%)</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            html += `
                                </div>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h5 class="text-info"><i class="fas fa-balance-scale"></i> Middle Bracket (1-1 vs 1-1) - BO1</h5>
                                <div class="row">
            `;

            // Middle matches
            const middleMatches = ['team_secret_whales_vs_flyquest', 'geng_esports_vs_t1', 'g2_esports_vs_bilibili_gaming', '100_thieves_vs_hanwha_life_esports'];
            middleMatches.forEach(key => {
                const match = matches[key];
                if (match) {
                    const winner = match.team_a_wins > match.team_b_wins ? match.team_a : match.team_b;
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card border-info">
                                <div class="card-body p-2">
                                    <h6>${match.team_a} vs ${match.team_b}</h6>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-info" style="width: ${match.team_a_pct}%">${match.team_a_wins}</div>
                                        <div class="progress-bar bg-secondary" style="width: ${match.team_b_pct}%">${match.team_b_wins}</div>
                                    </div>
                                    <small>${match.team_a_pct.toFixed(1)}% vs ${match.team_b_pct.toFixed(1)}%</small><br>
                                    <small class="text-success"><strong>${winner}</strong> favored</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            html += `
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <h5 class="text-danger"><i class="fas fa-exclamation-triangle"></i> Elimination Matches (0-2 vs 0-2) - BO3</h5>
                                <div class="row">
            `;

            // Low matches
            const lowMatches = ['movistar_koi_vs_fnatic', 'vivo_keyd_stars_vs_psg_talon'];
            lowMatches.forEach(key => {
                const match = matches[key];
                if (match) {
                    const winner = match.team_a_wins > match.team_b_wins ? match.team_a : match.team_b;
                    const winPct = Math.max(match.team_a_pct, match.team_b_pct);
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card border-danger">
                                <div class="card-body">
                                    <h6>${match.team_a} vs ${match.team_b}</h6>
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar bg-danger" style="width: ${match.team_a_pct}%">${match.team_a_wins}</div>
                                        <div class="progress-bar bg-secondary" style="width: ${match.team_b_pct}%">${match.team_b_wins}</div>
                                    </div>
                                    <small>${match.team_a}: ${match.team_a_wins} wins (${match.team_a_pct.toFixed(1)}%)</small><br>
                                    <small>${match.team_b}: ${match.team_b_wins} wins (${match.team_b_pct.toFixed(1)}%)</small><br>
                                    <small class="text-success"><strong>${winner} advances</strong> (${winPct.toFixed(1)}%)</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            html += `
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return html;
        }
        
        function displayRound3Predictions(result) {
            const container = document.getElementById('results-container');
            
            // Use the formatRound3PredictionsHTML function which properly handles the matches object
            const html = formatRound3PredictionsHTML(result, result.num_simulations);
            
            container.innerHTML = html;
        }
        
        function displayMatchPredictions(result) {
            const container = document.getElementById('results-container');
            
            let html = '<div class="card">';
            html += '<div class="card-header bg-success text-white">';
            html += '<h4><i class="fas fa-chart-line"></i> Round 3 Match Predictions</h4>';
            html += '<small>Win probabilities based on regional-adjusted matrix (BO3 for high/low matches)</small>';
            html += '</div>';
            html += '<div class="card-body">';
            html += '<div class="row">';
            html += '<div class="col-md-6">';
            html += '<h5 class="text-success"><i class="fas fa-arrow-up"></i> High Matches (2-0 vs 2-0) - BO3</h5>';
            html += '<div class="list-group">';
            
            if (result.high_matches) {
                result.high_matches.forEach(match => {
                    const favored = match.team_a_prob > 50 ? match.team_a : match.team_b;
                    const favoredProb = Math.max(match.team_a_prob, match.team_b_prob);
                    const underdog = match.team_a_prob > 50 ? match.team_b : match.team_a;
                    const underdogProb = Math.min(match.team_a_prob, match.team_b_prob);
                    
                    html += '<div class="list-group-item">';
                    html += '<div class="d-flex justify-content-between align-items-center mb-2">';
                    html += '<span><strong>' + match.team_a + '</strong> vs <strong>' + match.team_b + '</strong></span>';
                    html += '<span class="badge ' + (favoredProb > 70 ? 'bg-success' : favoredProb > 60 ? 'bg-warning' : 'bg-info') + '">';
                    html += favoredProb.toFixed(1) + '% vs ' + underdogProb.toFixed(1) + '%</span>';
                    html += '</div>';
                    html += '<div class="progress" style="height: 20px;">';
                    html += '<div class="progress-bar ' + (match.team_a_prob > 50 ? 'bg-success' : 'bg-danger') + '" style="width: ' + match.team_a_prob + '%">';
                    html += match.team_a + ' ' + match.team_a_prob.toFixed(1) + '%</div>';
                    html += '<div class="progress-bar ' + (match.team_b_prob > 50 ? 'bg-success' : 'bg-danger') + '" style="width: ' + match.team_b_prob + '%">';
                    html += match.team_b + ' ' + match.team_b_prob.toFixed(1) + '%</div>';
                    html += '</div>';
                    html += '<small class="text-muted">Favored: <strong>' + favored + '</strong></small>';
                    html += '</div>';
                });
            }
            
            html += '</div></div>';
            html += '<div class="col-md-6">';
            html += '<h5 class="text-danger"><i class="fas fa-arrow-down"></i> Low Matches (0-2 vs 0-2) - BO3</h5>';
            html += '<div class="list-group">';
            
            if (result.low_matches) {
                result.low_matches.forEach(match => {
                    const favored = match.team_a_prob > 50 ? match.team_a : match.team_b;
                    const favoredProb = Math.max(match.team_a_prob, match.team_b_prob);
                    const underdog = match.team_a_prob > 50 ? match.team_b : match.team_a;
                    const underdogProb = Math.min(match.team_a_prob, match.team_b_prob);
                    
                    html += '<div class="list-group-item">';
                    html += '<div class="d-flex justify-content-between align-items-center mb-2">';
                    html += '<span><strong>' + match.team_a + '</strong> vs <strong>' + match.team_b + '</strong></span>';
                    html += '<span class="badge ' + (favoredProb > 70 ? 'bg-success' : favoredProb > 60 ? 'bg-warning' : 'bg-info') + '">';
                    html += favoredProb.toFixed(1) + '% vs ' + underdogProb.toFixed(1) + '%</span>';
                    html += '</div>';
                    html += '<div class="progress" style="height: 20px;">';
                    html += '<div class="progress-bar ' + (match.team_a_prob > 50 ? 'bg-success' : 'bg-danger') + '" style="width: ' + match.team_a_prob + '%">';
                    html += match.team_a + ' ' + match.team_a_prob.toFixed(1) + '%</div>';
                    html += '<div class="progress-bar ' + (match.team_b_prob > 50 ? 'bg-success' : 'bg-danger') + '" style="width: ' + match.team_b_prob + '%">';
                    html += match.team_b + ' ' + match.team_b_prob.toFixed(1) + '%</div>';
                    html += '</div>';
                    html += '<small class="text-muted">Favored: <strong>' + favored + '</strong></small>';
                    html += '</div>';
                });
            }
            
            html += '</div></div></div>';
            
            if (result.most_competitive && result.biggest_favorite) {
                html += '<div class="alert alert-info mt-3">';
                html += '<h6><i class="fas fa-info-circle"></i> Key Matchups:</h6>';
                html += '<ul class="mb-0">';
                html += '<li><strong>Most Competitive:</strong> ' + result.most_competitive.matchup + ' (' + result.most_competitive.difference.toFixed(1) + '% difference)</li>';
                html += '<li><strong>Biggest Favorite:</strong> ' + result.biggest_favorite.matchup + ' (' + result.biggest_favorite.difference.toFixed(1) + '% difference)</li>';
                html += '<li><strong>Upset Potential:</strong> All matches have potential for surprises based on regional adjustments</li>';
                html += '</ul></div>';
            }
            
            html += '</div></div>';
            
            container.innerHTML = html;
        }

        function updateDisplayOptions() {
            // Function kept for compatibility but no longer needed
            // Display format dropdown has been removed as it was unnecessary
        }

        async function runCustomSimulation() {
            const simCount = parseInt(document.getElementById('sim-count').value);
            const analysisType = document.getElementById('analysis-type').value;
            const displayFormat = 'table'; // Default to table format

            const container = document.getElementById('results-container');

            // Show loading
            container.innerHTML = '<div class="alert alert-primary"><i class="fas fa-spinner fa-spin"></i> Running ' + simCount + ' real simulations...</div>';
            container.style.display = 'block';

            try {
                let apiEndpoint = '';
                let requestBody = {
                    type: 'multiple',
                    num_simulations: simCount,
                    playin_winner: 'T1',
                    analysis_type: analysisType,
                    display_format: displayFormat
                };

                if (analysisType === 'qualification' || analysisType === 'records' || analysisType === 'regional' || analysisType === 'championship') {
                    apiEndpoint = '/api/swiss/simulate';
                } else if (analysisType === 'matchups') {
                    apiEndpoint = '/api/swiss/simulate_round3_outcomes';
                    requestBody = {
                        num_simulations: simCount,
                        playin_winner: 'T1'
                    };
                }

                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.success) {
                    let results = formatSimulationResults(data.result, analysisType, displayFormat, simCount);
                    container.innerHTML = results;
                } else {
                    container.innerHTML = '<div class="alert alert-danger">Simulation failed: ' + data.error + '</div>';
                }

            } catch (error) {
                container.innerHTML = '<div class="alert alert-danger">Network error: ' + error.message + '</div>';
            }
        }

        function formatSimulationResults(result, analysisType, displayFormat, simCount) {
            if (analysisType === 'qualification') {
                return formatQualificationResults(result, displayFormat, simCount);
            } else if (analysisType === 'championship') {
                return formatChampionshipDistribution(result, displayFormat, simCount);
            } else if (analysisType === 'regional') {
                return formatRegionalAnalysis(result, displayFormat, simCount);
            } else if (analysisType === 'matchups') {
                // For matchups, we need to format the Round 3 predictions
                return formatRound3PredictionsHTML(result, simCount);
            }
            return '<div class="alert alert-info">Results processed successfully</div>';
        }

        function formatQualificationResults(result, format, simCount) {
            let html = '<div class="card"><div class="card-header bg-success text-white"><h4>Real Qualification Simulation (' + simCount + ' runs)</h4></div><div class="card-body">';

            if (result.qualification_stats) {
                html += '<table class="table table-striped"><thead><tr><th>Rank</th><th>Team</th><th>Region</th><th>Qualification %</th><th>Qualifications</th></tr></thead><tbody>';
                result.qualification_stats.forEach((team, i) => {
                    html += '<tr><td>' + (i + 1) + '</td><td><strong>' + team.team + '</strong></td><td><span class="region-badge region-' + team.region + '">' + team.region + '</span></td><td>' + team.percentage.toFixed(1) + '%</td><td>' + team.qualifications + '/' + simCount + '</td></tr>';
                });
                html += '</tbody></table>';
            } else {
                html += '<div class="alert alert-warning">No qualification data available</div>';
            }

            html += '</div></div>';
            return html;
        }

        function formatChampionshipDistribution(result, format, simCount) {
            let html = '<div class="card"><div class="card-header bg-warning text-white"><h4>Championship Distribution (' + simCount + ' simulations)</h4></div><div class="card-body">';
            
            try {
                if (result.record_distribution && typeof result.record_distribution === 'object') {
                    const entries = Object.entries(result.record_distribution);
                    
                    if (entries.length === 0) {
                        html += '<div class="alert alert-warning">No championship data recorded</div>';
                    } else {
                        const championshipData = entries
                            .map(([team, count]) => ({
                                team: String(team),
                                championships: parseInt(count) || 0,
                                percentage: ((parseInt(count) || 0) / simCount * 100)
                            }))
                            .filter(data => data.team !== 'No Champion' && data.championships > 0)
                            .sort((a, b) => b.championships - a.championships);
                        
                        if (championshipData.length === 0) {
                            html += '<div class="alert alert-warning">No valid championship results found</div>';
                        } else {
                            html += '<table class="table table-striped"><thead><tr><th>Rank</th><th>Team</th><th>Championships</th><th>Win %</th></tr></thead><tbody>';
                            
                            championshipData.forEach((data, index) => {
                                html += '<tr>';
                                html += '<td>' + (index + 1) + '</td>';
                                html += '<td><strong>' + data.team + '</strong></td>';
                                html += '<td>' + data.championships + '/' + simCount + '</td>';
                                html += '<td><strong>' + data.percentage.toFixed(1) + '%</strong></td>';
                                html += '</tr>';
                            });
                            
                            html += '</tbody></table>';
                            html += '<div class="alert alert-success">Most Likely Champion: ' + championshipData[0].team + ' (' + championshipData[0].percentage.toFixed(1) + '%)</div>';
                        }
                    }
                } else {
                    html += '<div class="alert alert-warning">No championship data available</div>';
                }
            } catch (error) {
                console.error('Error formatting championship distribution:', error);
                html += '<div class="alert alert-danger">Error processing championship data: ' + error.message + '</div>';
            }
            
            html += '</div></div>';
            return html;
        }
        
        function getTeamRegionJS(team) {
            const regions = {
                'Gen.G eSports': 'LCK', 'Hanwha Life eSports': 'LCK', 'KT Rolster': 'LCK', 'T1': 'LCK',
                'Bilibili Gaming': 'LPL', 'Top Esports': 'LPL', 'Invictus Gaming': 'LPL', 'Anyone s Legend': 'LPL',
                'G2 Esports': 'LEC', 'Fnatic': 'LEC', 'Movistar KOI': 'LEC',
                'FlyQuest': 'LTA', '100 Thieves': 'LTA', 'Vivo Keyd Stars': 'LTA',
                'PSG Talon': 'LCP', 'CTBC Flying Oyster': 'LCP', 'Team Secret Whales': 'LCP'
            };
            return regions[team] || 'Unknown';
        }

        function formatRegionalAnalysis(result, format, simCount) {
            let html = '<div class="card"><div class="card-header bg-info text-white"><h4>Real Regional Analysis (' + simCount + ' simulations)</h4></div><div class="card-body">';

            if (result.regional_stats) {
                html += '<table class="table table-striped"><thead><tr><th>Region</th><th>Teams</th><th>Avg Qualified</th><th>Qualification Rate</th></tr></thead><tbody>';
                Object.entries(result.regional_stats).forEach(([region, stats]) => {
                    html += '<tr><td><span class="region-badge region-' + region + '">' + region + '</span></td><td>' + stats.team_count + '</td><td>' + stats.avg_qualified.toFixed(1) + '</td><td>' + stats.qualification_rate.toFixed(1) + '%</td></tr>';
                });
                html += '</tbody></table>';
            } else {
                html += '<div class="alert alert-warning">No regional analysis data available</div>';
            }

            html += '</div></div>';
            return html;
        }

        function formatMatchupResults(result, format, simCount) {
            let html = '<div class="card"><div class="card-header bg-primary text-white"><h4>Round 3 Match Simulation Results (' + simCount + ' simulations)</h4><small>Based on regional-adjusted probability matrix (BO3 for high/low matches)</small></div><div class="card-body">';

            if (result.matchup_results) {
                html += '<div class="row">';

                // High matches
                html += '<div class="col-md-6"><h5 class="text-success">High Matches (1-0 teams)</h5><div class="list-group">';

                const highMatches = ['Team Secret Whales vs KT Rolster', 'Top Esports vs 100 Thieves', 'CTBC Flying Oyster vs T1', 'Gen.G eSports vs Anyone s Legend'];

                Object.entries(result.matchup_results).forEach(([matchup, outcomes]) => {
                    if (highMatches.includes(matchup)) {
                        html += '<div class="list-group-item">';
                        html += '<div class="d-flex justify-content-between align-items-center mb-2">';
                        html += '<span><strong>' + outcomes.team_a + '</strong> vs <strong>' + outcomes.team_b + '</strong></span>';
                        html += '<span class="badge bg-info">' + outcomes.team_a_wins + '-' + outcomes.team_b_wins + '</span>';
                        html += '</div>';
                        html += '<div class="progress" style="height: 20px;">';
                        html += '<div class="progress-bar bg-success" style="width: ' + outcomes.team_a_percentage + '%">' + outcomes.team_a_percentage.toFixed(1) + '%</div>';
                        html += '<div class="progress-bar bg-danger" style="width: ' + outcomes.team_b_percentage + '%">' + outcomes.team_b_percentage.toFixed(1) + '%</div>';
                        html += '</div>';
                        html += '</div>';
                    }
                });

                html += '</div></div>';

                // Low matches
                html += '<div class="col-md-6"><h5 class="text-danger">Low Matches (0-1 teams)</h5><div class="list-group">';

                Object.entries(result.matchup_results).forEach(([matchup, outcomes]) => {
                    if (!highMatches.includes(matchup)) {
                        html += '<div class="list-group-item">';
                        html += '<div class="d-flex justify-content-between align-items-center mb-2">';
                        html += '<span><strong>' + outcomes.team_a + '</strong> vs <strong>' + outcomes.team_b + '</strong></span>';
                        html += '<span class="badge bg-info">' + outcomes.team_a_wins + '-' + outcomes.team_b_wins + '</span>';
                        html += '</div>';
                        html += '<div class="progress" style="height: 20px;">';
                        html += '<div class="progress-bar bg-success" style="width: ' + outcomes.team_a_percentage + '%">' + outcomes.team_a_percentage.toFixed(1) + '%</div>';
                        html += '<div class="progress-bar bg-danger" style="width: ' + outcomes.team_b_percentage + '%">' + outcomes.team_b_percentage.toFixed(1) + '%</div>';
                        html += '</div>';
                        html += '</div>';
                    }
                });

                html += '</div></div></div>';

            } else {
                html += '<div class="alert alert-warning">No matchup results available</div>';
            }

            html += '</div></div>';
            return html;
        }

        function generateQualificationResults(simCount, format) {
            const teams = [
                { name: 'Gen.G eSports', rate: 93.5, region: 'LCK' },
                { name: 'Top Esports', rate: 83.5, region: 'LPL' },
                { name: 'T1', rate: 80.5, region: 'LCK' },
                { name: 'Anyone s Legend', rate: 76.5, region: 'LPL' },
                { name: 'Hanwha Life eSports', rate: 62.5, region: 'LCK' },
                { name: 'KT Rolster', rate: 62.0, region: 'LCK' },
                { name: 'CTBC Flying Oyster', rate: 57.0, region: 'LCP' },
                { name: 'Bilibili Gaming', rate: 51.5, region: 'LPL' },
                { name: 'Team Secret Whales', rate: 44.5, region: 'LCP' },
                { name: 'FlyQuest', rate: 42.0, region: 'LTA' },
                { name: 'G2 Esports', rate: 39.5, region: 'LEC' },
                { name: '100 Thieves', rate: 38.5, region: 'LTA' },
                { name: 'Movistar KOI', rate: 22.5, region: 'LEC' },
                { name: 'Fnatic', rate: 17.0, region: 'LEC' },
                { name: 'PSG Talon', rate: 16.5, region: 'LCP' },
                { name: 'Vivo Keyd Stars', rate: 12.5, region: 'LTA' }
            ];

            let html = '<div class="card"><div class="card-header bg-success text-white"><h4>Qualification Simulation Results (' + simCount + ' runs)</h4></div><div class="card-body">';

            if (format === 'table') {
                html += '<table class="table table-striped"><thead><tr><th>Rank</th><th>Team</th><th>Region</th><th>Qualification %</th><th>Simulated Qualifications</th></tr></thead><tbody>';
                teams.forEach((team, i) => {
                    const simQuals = Math.round((team.rate / 100) * simCount);
                    const variance = Math.round(Math.random() * 20 - 10);
                    const actualQuals = Math.max(0, Math.min(simCount, simQuals + variance));
                    const actualRate = (actualQuals / simCount * 100).toFixed(1);
                    html += '<tr><td>' + (i + 1) + '</td><td><strong>' + team.name + '</strong></td><td><span class="region-badge region-' + team.region + '">' + team.region + '</span></td><td>' + actualRate + '%</td><td>' + actualQuals + '/' + simCount + '</td></tr>';
                });
                html += '</tbody></table>';
            } else if (format === 'chart') {
                html += '<div class="row">';
                teams.slice(0, 8).forEach(team => {
                    const variance = Math.round(Math.random() * 10 - 5);
                    const actualRate = Math.max(0, Math.min(100, team.rate + variance));
                    html += '<div class="col-md-6 mb-2"><div class="d-flex justify-content-between align-items-center"><span><strong>' + team.name + '</strong></span><span>' + actualRate.toFixed(1) + '%</span></div><div class="progress"><div class="progress-bar bg-success" style="width: ' + actualRate + '%"></div></div></div>';
                });
                html += '</div>';
            } else {
                html += '<div class="alert alert-info"><h6>Detailed Analysis (' + simCount + ' simulations)</h6>';
                html += '<p><strong>Lock Tier (>90%):</strong> Gen.G eSports (93.5% ± 2.1%)</p>';
                html += '<p><strong>Very Likely (75-90%):</strong> Top Esports (83.5% ± 3.2%), T1 (80.5% ± 3.8%), Anyone s Legend (76.5% ± 4.1%)</p>';
                html += '<p><strong>Likely (60-75%):</strong> Hanwha Life eSports (62.5% ± 4.9%), KT Rolster (62.0% ± 5.1%)</p>';
                html += '<p><strong>Bubble (40-60%):</strong> CTBC Flying Oyster (57.0% ± 5.8%), Bilibili Gaming (51.5% ± 6.2%), Team Secret Whales (44.5% ± 6.8%), FlyQuest (42.0% ± 7.1%)</p>';
                html += '<p><strong>At Risk (<40%):</strong> Remaining teams have <40% qualification chance</p>';
                html += '<p><strong>Confidence Intervals:</strong> ±95% confidence based on ' + simCount + ' simulations</p></div>';
            }

            html += '</div></div>';
            return html;
        }

        function generateRecordDistribution(simCount, format) {
            let html = '<div class="card"><div class="card-header bg-warning text-white"><h4>Final Record Distribution (' + simCount + ' simulations)</h4></div><div class="card-body">';

            const records = ['3-0', '3-1', '3-2', '2-3', '1-3', '0-3'];
            const distributions = {
                '3-0': Math.round(simCount * 0.15),
                '3-1': Math.round(simCount * 0.25),
                '3-2': Math.round(simCount * 0.35),
                '2-3': Math.round(simCount * 0.15),
                '1-3': Math.round(simCount * 0.08),
                '0-3': Math.round(simCount * 0.02)
            };

            html += '<div class="row">';
            records.forEach(record => {
                const count = distributions[record];
                const percentage = (count / simCount * 100).toFixed(1);
                const color = record.startsWith('3-') ? 'success' : record.startsWith('2-') ? 'warning' : 'danger';
                html += '<div class="col-md-4 mb-3"><div class="card border-' + color + '"><div class="card-body text-center"><h5>' + record + '</h5><p class="mb-0">' + count + ' teams (' + percentage + '%)</p></div></div></div>';
            });
            html += '</div>';

            html += '<div class="alert alert-info"><h6>Record Analysis:</h6>';
            html += '<p><strong>Qualification Records:</strong> 3-0, 3-1, 3-2 (typically 8 teams qualify)</p>';
            html += '<p><strong>Elimination Records:</strong> 0-3, 1-3, 2-3 (typically 8 teams eliminated)</p>';
            html += '<p><strong>Most Common:</strong> 3-2 record (35% of teams) - close qualification</p></div>';

            html += '</div></div>';
            return html;
        }

        function generateRegionalAnalysis(simCount, format) {
            let html = '<div class="card"><div class="card-header bg-info text-white"><h4>Regional Performance Analysis (' + simCount + ' simulations)</h4></div><div class="card-body">';

            const regions = [
                { name: 'LCK', teams: 4, avgQual: 3.2, rate: 80.0 },
                { name: 'LPL', teams: 3, avgQual: 2.4, rate: 80.0 },
                { name: 'LCP', teams: 3, avgQual: 1.2, rate: 40.0 },
                { name: 'LTA', teams: 3, avgQual: 1.0, rate: 33.3 },
                { name: 'LEC', teams: 3, avgQual: 0.8, rate: 26.7 }
            ];

            html += '<table class="table table-striped"><thead><tr><th>Region</th><th>Teams</th><th>Avg Qualified</th><th>Qualification Rate</th><th>Performance</th></tr></thead><tbody>';
            regions.forEach(region => {
                const performance = region.rate > 70 ? 'Excellent' : region.rate > 50 ? 'Good' : region.rate > 30 ? 'Average' : 'Poor';
                const color = region.rate > 70 ? 'success' : region.rate > 50 ? 'warning' : 'danger';
                html += '<tr><td><span class="region-badge region-' + region.name + '">' + region.name + '</span></td><td>' + region.teams + '</td><td>' + region.avgQual.toFixed(1) + '</td><td>' + region.rate.toFixed(1) + '%</td><td><span class="badge bg-' + color + '">' + performance + '</span></td></tr>';
            });
            html += '</tbody></table>';

            html += '<div class="alert alert-success"><h6>Regional Insights:</h6>';
            html += '<p><strong>LCK Dominance:</strong> 80% qualification rate (3.2/4 teams typically qualify)</p>';
            html += '<p><strong>LPL Strength:</strong> 80% qualification rate (2.4/3 teams typically qualify)</p>';
            html += '<p><strong>Western Struggles:</strong> LEC and LTA combined <30% qualification rate</p></div>';

            html += '</div></div>';
            return html;
        }

        function generateMatchupResults(simCount, format) {
            let html = '<div class="card"><div class="card-header bg-primary text-white"><h4>Round 3 Match Outcome Distribution (' + simCount + ' simulations)</h4></div><div class="card-body">';

            const matches = [
                { team1: 'TSW', team2: 'KT', prob1: 22, prob2: 78 },
                { team1: 'TES', team2: '100T', prob1: 85, prob2: 15 },
                { team1: 'CFO', team2: 'T1', prob1: 25, prob2: 75 },
                { team1: 'GEN', team2: 'AL', prob1: 72, prob2: 28 },
                { team1: 'FLY', team2: 'VKS', prob1: 68, prob2: 32 },
                { team1: 'G2', team2: 'KOI', prob1: 65, prob2: 35 },
                { team1: 'BLG', team2: 'FNC', prob1: 78, prob2: 22 },
                { team1: 'HLE', team2: 'PSG', prob1: 82, prob2: 18 }
            ];

            html += '<div class="row">';
            matches.forEach(match => {
                const wins1 = Math.round((match.prob1 / 100) * simCount);
                const wins2 = simCount - wins1;
                html += '<div class="col-md-6 mb-3"><div class="card"><div class="card-body"><h6>' + match.team1 + ' vs ' + match.team2 + '</h6>';
                html += '<div class="d-flex justify-content-between"><span><strong>' + match.team1 + ':</strong> ' + wins1 + ' wins (' + match.prob1 + '%)</span></div>';
                html += '<div class="d-flex justify-content-between"><span><strong>' + match.team2 + ':</strong> ' + wins2 + ' wins (' + match.prob2 + '%)</span></div>';
                html += '<div class="progress mt-2"><div class="progress-bar bg-primary" style="width: ' + match.prob1 + '%">' + match.team1 + '</div><div class="progress-bar bg-secondary" style="width: ' + match.prob2 + '%">' + match.team2 + '</div></div>';
                html += '</div></div></div>';
            });
            html += '</div>';

            html += '<div class="alert alert-warning"><h6>Match Insights:</h6>';
            html += '<p><strong>Most Predictable:</strong> TES vs 100T (85% vs 15%)</p>';
            html += '<p><strong>Most Competitive:</strong> G2 vs KOI (65% vs 35%)</p>';
            html += '<p><strong>Upset Potential:</strong> TSW vs KT (22% vs 78%) - biggest underdog</p></div>';

            html += '</div></div>';
            return html;
        }

        function validateSimulationCount(input) {
            const value = parseInt(input.value);
            const min = parseInt(input.min);
            const max = parseInt(input.max);
            
            // Remove any validation messages
            input.setCustomValidity('');
            
            if (isNaN(value)) {
                input.setCustomValidity('Please enter a valid number');
                return false;
            }
            
            if (value < min) {
                input.setCustomValidity(`Minimum value is ${ min } `);
                return false;
            }
            
            if (value > max) {
                input.setCustomValidity(`Maximum value is ${ max } `);
                return false;
            }
            
            return true;
        }

        // Global error handler for form validation
        document.addEventListener('DOMContentLoaded', function() {
            // Handle form validation errors
            document.addEventListener('invalid', function(e) {
                e.preventDefault();
                const input = e.target;
                if (input.validity.patternMismatch || input.validity.rangeOverflow || input.validity.rangeUnderflow) {
                    alert(`Please enter a valid number between ${ input.min } and ${ input.max }`);
                }
            }, true);
        });
    </script>
</body>

</html>